name: Auto Fix

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  parse-command:
    if: |
      github.event.issue.pull_request && 
      (contains(github.event.comment.body, '/fix') || 
       contains(github.event.comment.body, '/format') ||
       contains(github.event.comment.body, '/test'))
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      args: ${{ steps.parse.outputs.args }}
    steps:
      - name: Parse command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          
          # ã‚³ãƒãƒ³ãƒ‰ã‚’æŠ½å‡º
          if [[ "$COMMENT" =~ /fix ]]; then
            COMMAND="fix"
            ARGS="${COMMENT#*/fix }"
          elif [[ "$COMMENT" =~ /format ]]; then
            COMMAND="format"
            ARGS=""
          elif [[ "$COMMENT" =~ /test ]]; then
            COMMAND="test"
            ARGS="${COMMENT#*/test }"
          fi
          
          echo "command=$COMMAND" >> $GITHUB_OUTPUT
          echo "args=$ARGS" >> $GITHUB_OUTPUT

  auto-fix:
    needs: parse-command
    if: needs.parse-command.outputs.command == 'fix'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR branch
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return pr.data.head.ref;
      
      - uses: actions/checkout@v4
        with:
          ref: ${{ fromJSON(steps.pr.outputs.result) }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux expect jq
      
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
      
      - name: Post status comment
        uses: actions/github-script@v7
        id: status-comment
        with:
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– **CCTeam Auto Fix**\n\nä¿®æ­£ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...\n\nè¦æ±‚: ${{ needs.parse-command.outputs.args }}`
            });
            return comment.id;
      
      - name: Run fix
        id: fix
        run: |
          # ç°¡æ˜“çš„ãªä¿®æ­£å®Ÿè¡Œï¼ˆå®Ÿéš›ã®CCTeamèµ·å‹•ã¯ç’°å¢ƒä¾å­˜ã®ãŸã‚çœç•¥ï¼‰
          echo "ä¿®æ­£è¦æ±‚: ${{ needs.parse-command.outputs.args }}" > fix-request.txt
          
          # ã“ã“ã§å®Ÿéš›ã®ä¿®æ­£å‡¦ç†ã‚’å®Ÿè¡Œ
          # ä¾‹: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ç°¡å˜ãªãƒã‚°ä¿®æ­£ãªã©
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.fix.outputs.has_changes == 'true'
        run: |
          git config user.name "CCTeam Bot"
          git config user.email "ccteam@bot.local"
          
          git add -A
          git commit -m "fix: Auto-fix requested by @${{ github.event.comment.user.login }}

          Fix request: ${{ needs.parse-command.outputs.args }}
          
          Co-authored-by: ${{ github.event.comment.user.login }} <${{ github.event.comment.user.id }}+${{ github.event.comment.user.login }}@users.noreply.github.com>"
          
          git push
      
      - name: Update status comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.fix.outputs.has_changes }}' === 'true' 
              ? 'âœ… ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸï¼å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸã€‚' 
              : 'â„¹ï¸ ä¿®æ­£å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.status-comment.outputs.result }},
              body: `ğŸ¤– **CCTeam Auto Fix**\n\n${status}\n\nè¦æ±‚: ${{ needs.parse-command.outputs.args }}`
            });

  format:
    needs: parse-command
    if: needs.parse-command.outputs.command == 'format'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR branch
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return pr.data.head.ref;
      
      - uses: actions/checkout@v4
        with:
          ref: ${{ fromJSON(steps.pr.outputs.result) }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          fi
      
      - name: Run formatters
        run: |
          # Prettier
          if [ -f package.json ] && grep -q "prettier" package.json; then
            npx prettier --write . || true
          fi
          
          # Shell script formatting
          find scripts -name "*.sh" -type f -exec chmod +x {} \;
      
      - name: Commit changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git config user.name "CCTeam Bot"
            git config user.email "ccteam@bot.local"
            
            git add -A
            git commit -m "style: Auto-format code

            Requested by: @${{ github.event.comment.user.login }}
            
            Co-authored-by: ${{ github.event.comment.user.login }} <${{ github.event.comment.user.id }}+${{ github.event.comment.user.login }}@users.noreply.github.com>"
            
            git push
          fi
      
      - name: Post result
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ¨ ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼`
            });

  test:
    needs: parse-command
    if: needs.parse-command.outputs.command == 'test'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux expect jq
      
      - name: Run specific tests
        run: |
          TEST_TARGET="${{ needs.parse-command.outputs.args }}"
          
          if [ -z "$TEST_TARGET" ]; then
            # å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            if [ -f ./tests/integration_test.sh ]; then
              ./tests/integration_test.sh
            fi
          else
            # ç‰¹å®šã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            echo "Running tests for: $TEST_TARGET"
            # ã“ã“ã«ç‰¹å®šã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
          fi
      
      - name: Post results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const emoji = success ? 'âœ…' : 'âŒ';
            const status = success ? 'æˆåŠŸ' : 'å¤±æ•—';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${emoji} ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ: **${status}**\n\nãƒ†ã‚¹ãƒˆå¯¾è±¡: ${{ needs.parse-command.outputs.args || 'å…¨ä½“' }}`
            });