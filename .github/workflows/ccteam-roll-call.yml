name: CCTeam Roll Call

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®æ–¹æ³•ã§ãƒˆãƒªã‚¬ãƒ¼ã§ãã¾ã™ï¼š
# 1. GitHub Actions UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰
# 2. Issue/PRã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œ/roll-callã€ã‚³ãƒžãƒ³ãƒ‰ã‚’ä½¿ç”¨
#
# ä½¿ç”¨ä¾‹:
#   - Issue/PRã§ã€Œ/roll-callã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆ
#   - ã€Œ/roll-call --verboseã€ã§è©³ç´°ãƒ¢ãƒ¼ãƒ‰
#   - ã€Œ/roll-call --checkã€ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä»˜ã

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›'
        required: false
        default: 'false'
        type: boolean
      health_check:
        description: 'ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ'
        required: false
        default: 'true'
        type: boolean
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

# ä¸¦è¡Œå‡¦ç†åˆ¶å¾¡
concurrency:
  group: roll-call-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  roll-call:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '/roll-call'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup environment
        run: |
          echo "ðŸ“¦ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹..."
          sudo apt-get update
          sudo apt-get install -y tmux expect jq sqlite3
          
          # Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—æ¤œå‡ºãªã©ã«ä½¿ç”¨ï¼‰
          python3 -m pip install --upgrade pip
          pip3 install jinja2
          
      - name: React to comment (if triggered by comment)
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
            
      - name: Setup CCTeam environment
        run: |
          echo "ðŸ”§ CCTeamç’°å¢ƒã‚’æº–å‚™ä¸­..."
          
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
          chmod +x scripts/*.sh
          chmod +x scripts/common/*.sh || true
          
          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p logs memory worktrees shared-docs
          
          # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆå®Ÿéš›ã®CCTeamèµ·å‹•ã¯ã—ãªã„ï¼‰
          tmux new-session -d -s ccteam-demo || true
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
          if [ -f "./scripts/project-status.sh" ]; then
            echo "ðŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹:"
            ./scripts/project-status.sh || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ã®å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          fi
          
      - name: Simulate Roll Call
        id: roll-call
        run: |
          # ã‚³ãƒžãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è§£æž
          COMMENT_BODY="${{ github.event.comment.body || '' }}"
          VERBOSE=false
          HEALTH_CHECK=true
          
          if [[ "$COMMENT_BODY" == *"--verbose"* ]] || [[ "${{ github.event.inputs.verbose }}" == "true" ]]; then
            VERBOSE=true
          fi
          
          if [[ "$COMMENT_BODY" == *"--no-check"* ]] || [[ "${{ github.event.inputs.health_check }}" == "false" ]]; then
            HEALTH_CHECK=false
          fi
          
          echo "âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³: VERBOSE=$VERBOSE, HEALTH_CHECK=$HEALTH_CHECK"
          
          # ãƒ¬ãƒãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½œæˆ
          cat > roll-call-result.md << 'EOF'
# ðŸ¤– CCTeam Roll Call Report

**å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S %Z')
**å®Ÿè¡Œç’°å¢ƒ**: GitHub Actions
**å®Ÿè¡Œè€…**: ${{ github.actor }}
**ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}

EOF
          
          # ç’°å¢ƒæƒ…å ±ã®è¿½åŠ ï¼ˆverboseãƒ¢ãƒ¼ãƒ‰ï¼‰
          if [ "$VERBOSE" = true ]; then
            cat >> roll-call-result.md << 'EOF'
## ðŸ“‹ ç’°å¢ƒæƒ…å ±

| é …ç›® | å€¤ |
|------|----|
| Runner OS | ${{ runner.os }} |
| Node Version | $(node --version) |
| Python Version | $(python3 --version) |
| tmux Version | $(tmux -V) |
| Repository | ${{ github.repository }} |
| Branch | ${{ github.ref }} |

EOF
          fi
          
          echo "## ðŸŽ¯ Agent Roll Call Results" >> roll-call-result.md
          echo "" >> roll-call-result.md
          
          # å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆè©³ç´°ç‰ˆï¼‰
          echo "### ðŸ‘‘ BOSS (Strategic Manager)" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "Response: Hello, World!! I'm BOSS - Strategic Manager ready for duty!" >> roll-call-result.md
          echo "Status: âœ… Active" >> roll-call-result.md
          echo "Role: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®çµ±æ‹¬ãƒ»ã‚¿ã‚¹ã‚¯åˆ†é…ãƒ»é€²æ—ç®¡ç†" >> roll-call-result.md
          echo "tmux: ccteam-boss:main.0" >> roll-call-result.md
          if [ "$VERBOSE" = true ]; then
            echo "Instructions: $(ls -la instructions/boss.md 2>/dev/null && echo 'Found' || echo 'Not found')" >> roll-call-result.md
          fi
          echo "\`\`\`" >> roll-call-result.md
          echo "" >> roll-call-result.md
          
          echo "### ðŸ’» Worker1 (Frontend Developer)" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "Response: Hello, World!! I'm Worker1 - Frontend Developer reporting!" >> roll-call-result.md
          echo "Status: âœ… Active" >> roll-call-result.md
          echo "Role: UI/UXå®Ÿè£…ãƒ»React/Next.jsé–‹ç™ºãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³" >> roll-call-result.md
          echo "tmux: ccteam:main.0" >> roll-call-result.md
          echo "Skills: React 18, Next.js 14, TypeScript, Tailwind CSS" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "" >> roll-call-result.md
          
          echo "### âš™ï¸ Worker2 (Backend Developer)" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "Response: Hello, World!! I'm Worker2 - Backend Developer online!" >> roll-call-result.md
          echo "Status: âœ… Active" >> roll-call-result.md
          echo "Role: APIé–‹ç™ºãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯" >> roll-call-result.md
          echo "tmux: ccteam:main.1" >> roll-call-result.md
          echo "Skills: Node.js, Express, FastAPI, PostgreSQL, Redis" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "" >> roll-call-result.md
          
          echo "### ðŸ§ª Worker3 (QA/DevOps Engineer)" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "Response: Hello, World!! I'm Worker3 - QA Engineer ready for testing!" >> roll-call-result.md
          echo "Status: âœ… Active" >> roll-call-result.md
          echo "Role: ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ãƒ»CI/CDæ§‹ç¯‰ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ãƒ»å“è³ªä¿è¨¼" >> roll-call-result.md
          echo "tmux: ccteam:main.2" >> roll-call-result.md
          echo "Skills: Jest, Playwright, GitHub Actions, Docker, Kubernetes" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "" >> roll-call-result.md
          
          echo "### ðŸŒŸ Gemini (AI Strategic Advisor)" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "Response: Hello, World!! I'm Gemini - AI Strategic Advisor available!" >> roll-call-result.md
          echo "Status: âœ… Active" >> roll-call-result.md
          echo "Role: èª¿æŸ»ãƒ»åˆ†æžãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆãƒ»æŠ€è¡“ã‚¢ãƒ‰ãƒã‚¤ã‚¹" >> roll-call-result.md
          echo "tmux: ccteam-boss:main.1" >> roll-call-result.md
          echo "Capabilities: ãƒžãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«åˆ†æžãƒ»ã‚³ãƒ¼ãƒ‰è§£æžãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ" >> roll-call-result.md
          echo "\`\`\`" >> roll-call-result.md
          echo "" >> roll-call-result.md
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          if [ "$HEALTH_CHECK" = true ]; then
            cat >> roll-call-result.md << 'EOF'
## ðŸ¥ System Health Check

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
\`\`\`
EOF
            ls -la scripts/ | head -5 >> roll-call-result.md || echo "scripts/: ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯" >> roll-call-result.md
            echo "\`\`\`" >> roll-call-result.md
            echo "" >> roll-call-result.md
            
            echo "### é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª" >> roll-call-result.md
            echo "| ãƒ•ã‚¡ã‚¤ãƒ« | çŠ¶æ…‹ |" >> roll-call-result.md
            echo "|----------|------|" >> roll-call-result.md
            
            # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            for file in "CLAUDE.md" "README.md" "package.json" ".mcp.json" "install.sh"; do
              if [ -f "$file" ]; then
                echo "| $file | âœ… å­˜åœ¨ |" >> roll-call-result.md
              else
                echo "| $file | âŒ ä¸åœ¨ |" >> roll-call-result.md
              fi
            done
            echo "" >> roll-call-result.md
          fi
          
          # å®Ÿè¡Œæ‰‹é †ã®è¿½åŠ 
          cat >> roll-call-result.md << 'EOF'
## ðŸ“ ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ‰‹é †

### 1. CCTeamã®èµ·å‹•
\`\`\`bash
# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒžãƒ³ãƒ‰ã¨ã—ã¦å®Ÿè¡Œ
ccteam

# ã¾ãŸã¯ç›´æŽ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
./scripts/launch-ccteam-v3.sh
\`\`\`

### 2. Roll Callã®å®Ÿè¡Œ
\`\`\`bash
# æ‹¡å¼µç‰ˆagent-sendã‚’ä½¿ç”¨
./scripts/enhanced_agent_send.sh boss "Hello, World!! I'm BOSS"
./scripts/enhanced_agent_send.sh worker1 "Hello, World!! I'm Worker1"
./scripts/enhanced_agent_send.sh worker2 "Hello, World!! I'm Worker2"
./scripts/enhanced_agent_send.sh worker3 "Hello, World!! I'm Worker3"

# ã¾ãŸã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒžãƒ³ãƒ‰ã§
ccsend boss "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å ±å‘Šã—ã¦ãã ã•ã„"
ccsend worker1 "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é€²æ—ã¯ï¼Ÿ"
ccsend worker2 "APIã®å®Ÿè£…çŠ¶æ³ã¯ï¼Ÿ"
ccsend worker3 "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ï¼Ÿ"
\`\`\`

### 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
\`\`\`bash
# CCTeamãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’èµ·å‹•
ccmon

# ã¾ãŸã¯é€šä¿¡ãƒ­ã‚°ã‚’ç›£è¦–
tail -f logs/communication.log
\`\`\`

---

**Note**: ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯GitHub Actionsç’°å¢ƒã§ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®CCTeamã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®é€šä¿¡ã«ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¾ãŸã¯DevContainerã§ã®å®Ÿè¡ŒãŒå¿…è¦ã§ã™ã€‚

*Generated at: $(date -u)*
EOF
          
      - name: Post roll call results
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('roll-call-result.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
            
      - name: Upload roll call report
        uses: actions/upload-artifact@v3
        with:
          name: roll-call-report
          path: roll-call-result.md