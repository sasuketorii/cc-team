name: Claude Code Action

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, edited]
  
permissions:
  contents: write
  pull-requests: write
  issues: write
  
jobs:
  claude-task:
    # @claudeメンションがある場合に実行
    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.issue.body, '@claude') ||
      contains(github.event.pull_request.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      # Claude Code Actionを実行（MAXプラン連携済み）
      - name: Execute Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # MAXプランのGitHub連携により認証は自動
          prompt: |
            ${{ github.event.comment.body || github.event.issue.body || github.event.pull_request.body }}
          model: claude-opus-4-20250514
          allowed_tools: "Edit,View,Bash,Write,Read"
          
      # コミットメッセージにCo-Authored-Byを追加
      - name: Amend commit if needed
        if: steps.claude.outputs.changes_made == 'true'
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@ccteam.dev"
          
          # 最後のコミットにCo-Authored-Byを追加
          git commit --amend -m "$(git log -1 --pretty=%B)

          🤖 Generated with Claude Code
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
  # CCTeam用の特別なタスク処理
  ccteam-boss-task:
    if: |
      contains(github.event.comment.body, '@claude boss') ||
      contains(github.event.comment.body, '@claude ccteam')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Analyze CCTeam request
        id: analyze
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # @claude boss以降のテキストを抽出
          TASK=$(echo "$COMMENT" | sed -n 's/.*@claude boss \(.*\)/\1/p')
          echo "task=$TASK" >> $GITHUB_OUTPUT
          
      - name: Execute CCTeam Boss task
        uses: anthropics/claude-code-base-action@beta
        with:
          # MAXプランのGitHub連携により認証は自動
          prompt: |
            あなたはCCTeamのBossエージェントです。
            以下のタスクを実行してください：
            
            ${{ steps.analyze.outputs.task }}
            
            1. requirements/ディレクトリの要件を確認
            2. 適切なWorkerの作業を想定して計画立案
            3. 実装方針をドキュメント化
            4. 必要に応じてコードの雛形を作成
            
            CCTeamのBossとして振る舞い、プロジェクト管理の観点から対応してください。
          allowed_tools: "Edit,View,Write,Read,Bash"
          cwd: ${{ github.workspace }}
          
      - name: Create pull request
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "🤖 CCTeam Boss: ${{ steps.analyze.outputs.task }}"
          body: |
            ## CCTeam Boss Task Execution
            
            **Task**: ${{ steps.analyze.outputs.task }}
            
            This PR was automatically created by CCTeam Boss via Claude Code Action.
            
            ### Changes
            - Requirements analysis completed
            - Implementation plan documented
            - Code scaffolding created
            
            Please review the changes before merging.
          branch: ccteam-boss-${{ github.run_id }}
          
  # バージョンリリースの自動化
  auto-release:
    if: contains(github.event.comment.body, '@claude release')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Determine version bump
        id: version
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ $COMMENT == *"major"* ]]; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif [[ $COMMENT == *"minor"* ]]; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          else
            echo "bump=patch" >> $GITHUB_OUTPUT
          fi
          
      - name: Execute release tasks
        uses: anthropics/claude-code-action@beta
        with:
          # MAXプランのGitHub連携により認証は自動
          prompt: |
            以下のリリースタスクを実行：
            1. CHANGELOGを更新
            2. バージョン番号を${{ steps.version.outputs.bump }}でアップデート
            3. リリースノートを生成
          allowed_tools: "Edit,View,Write,Bash"
          
      - name: Create version tag
        run: |
          git config user.name "Claude Release Bot"
          git config user.email "release-bot@ccteam.dev"
          
          # バージョンを取得
          VERSION=$(cat package.json | jq -r .version)
          
          # タグを作成
          git tag -a "v$VERSION" -m "Release v$VERSION

          Automated release by Claude Code Action"
          
          # プッシュ
          git push origin main --tags
          
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          release_name: Release v${{ steps.version.outputs.new_version }}
          body: |
            ## 🚀 Automated Release
            
            This release was automatically created by @claude
            
            ### Changes
            See CHANGELOG.md for details
          draft: false
          prerelease: false