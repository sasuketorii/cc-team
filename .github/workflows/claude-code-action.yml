name: Claude Code Action

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, edited]
  
permissions:
  contents: write
  pull-requests: write
  issues: write
  
jobs:
  claude-task:
    # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã«å®Ÿè¡Œ
    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.issue.body, '@claude') ||
      contains(github.event.pull_request.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      # Claude Code Actionã‚’å®Ÿè¡Œï¼ˆMAXãƒ—ãƒ©ãƒ³é€£æºæ¸ˆã¿ï¼‰
      - name: Execute Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # MAXãƒ—ãƒ©ãƒ³ã®GitHubé€£æºã«ã‚ˆã‚Šèªè¨¼ã¯è‡ªå‹•
          prompt: |
            ${{ github.event.comment.body || github.event.issue.body || github.event.pull_request.body }}
          model: claude-opus-4-20250514
          allowed_tools: "Edit,View,Bash,Write,Read"
          
      # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«Co-Authored-Byã‚’è¿½åŠ 
      - name: Amend commit if needed
        if: steps.claude.outputs.changes_made == 'true'
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@ccteam.dev"
          
          # æœ€å¾Œã®ã‚³ãƒŸãƒƒãƒˆã«Co-Authored-Byã‚’è¿½åŠ 
          git commit --amend -m "$(git log -1 --pretty=%B)

          ğŸ¤– Generated with Claude Code
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
  # CCTeamç”¨ã®ç‰¹åˆ¥ãªã‚¿ã‚¹ã‚¯å‡¦ç†
  ccteam-boss-task:
    if: |
      contains(github.event.comment.body, '@claude boss') ||
      contains(github.event.comment.body, '@claude ccteam')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Analyze CCTeam request
        id: analyze
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # @claude bossä»¥é™ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
          TASK=$(echo "$COMMENT" | sed -n 's/.*@claude boss \(.*\)/\1/p')
          echo "task=$TASK" >> $GITHUB_OUTPUT
          
      - name: Execute CCTeam Boss task
        uses: anthropics/claude-code-base-action@beta
        with:
          # MAXãƒ—ãƒ©ãƒ³ã®GitHubé€£æºã«ã‚ˆã‚Šèªè¨¼ã¯è‡ªå‹•
          prompt: |
            ã‚ãªãŸã¯CCTeamã®Bossã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            ${{ steps.analyze.outputs.task }}
            
            1. requirements/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¦ä»¶ã‚’ç¢ºèª
            2. é©åˆ‡ãªWorkerã®ä½œæ¥­ã‚’æƒ³å®šã—ã¦è¨ˆç”»ç«‹æ¡ˆ
            3. å®Ÿè£…æ–¹é‡ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–
            4. å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ã®é››å½¢ã‚’ä½œæˆ
            
            CCTeamã®Bossã¨ã—ã¦æŒ¯ã‚‹èˆã„ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®è¦³ç‚¹ã‹ã‚‰å¯¾å¿œã—ã¦ãã ã•ã„ã€‚
          allowed_tools: "Edit,View,Write,Read,Bash"
          cwd: ${{ github.workspace }}
          
      - name: Create pull request
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ¤– CCTeam Boss: ${{ steps.analyze.outputs.task }}"
          body: |
            ## CCTeam Boss Task Execution
            
            **Task**: ${{ steps.analyze.outputs.task }}
            
            This PR was automatically created by CCTeam Boss via Claude Code Action.
            
            ### Changes
            - Requirements analysis completed
            - Implementation plan documented
            - Code scaffolding created
            
            Please review the changes before merging.
          branch: ccteam-boss-${{ github.run_id }}
          
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹ã®è‡ªå‹•åŒ–
  auto-release:
    if: contains(github.event.comment.body, '@claude release')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Determine version bump
        id: version
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ $COMMENT == *"major"* ]]; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif [[ $COMMENT == *"minor"* ]]; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          else
            echo "bump=patch" >> $GITHUB_OUTPUT
          fi
          
      - name: Execute release tasks
        uses: anthropics/claude-code-action@beta
        with:
          # MAXãƒ—ãƒ©ãƒ³ã®GitHubé€£æºã«ã‚ˆã‚Šèªè¨¼ã¯è‡ªå‹•
          prompt: |
            ä»¥ä¸‹ã®ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œï¼š
            1. CHANGELOGã‚’æ›´æ–°
            2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’${{ steps.version.outputs.bump }}ã§ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
            3. ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          allowed_tools: "Edit,View,Write,Bash"
          
      - name: Create version tag
        run: |
          git config user.name "Claude Release Bot"
          git config user.email "release-bot@ccteam.dev"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          VERSION=$(cat package.json | jq -r .version)
          
          # ã‚¿ã‚°ã‚’ä½œæˆ
          git tag -a "v$VERSION" -m "Release v$VERSION

          Automated release by Claude Code Action"
          
          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin main --tags
          
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          release_name: Release v${{ steps.version.outputs.new_version }}
          body: |
            ## ğŸš€ Automated Release
            
            This release was automatically created by @claude
            
            ### Changes
            See CHANGELOG.md for details
          draft: false
          prerelease: false