name: Maintenance

on:
  schedule:
    - cron: '0 17 * * *' # æ¯Žæ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰
  workflow_dispatch:
    inputs:
      cleanup_logs:
        description: 'Clean up old logs'
        required: false
        default: 'true'
        type: boolean
      update_deps:
        description: 'Update dependencies'
        required: false
        default: 'true'
        type: boolean
      generate_report:
        description: 'Generate maintenance report'
        required: false
        default: 'true'
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Clean up old logs
        if: github.event.inputs.cleanup_logs != 'false'
        run: |
          echo "ðŸ§¹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹..."
          
          # log_rotation.shãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å®Ÿè¡Œ
          if [ -f ./scripts/log_rotation.sh ]; then
            ./scripts/log_rotation.sh
          else
            # æ‰‹å‹•ã§ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
            find logs -name "*.log" -type f -mtime +30 -delete 2>/dev/null || true
            find logs -name "*.log" -type f -size +10M -exec gzip {} \; 2>/dev/null || true
          fi
          
          # å¤ã„ãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å‰Šé™¤
          if [ -f ./scripts/cleanup_obsolete_files.sh ]; then
            ./scripts/cleanup_obsolete_files.sh
          else
            find tests/history -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true
          fi
          
          echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
      
      - name: Check disk usage
        run: |
          echo "ðŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
          du -sh ./* | sort -hr | head -20
      
      - name: Create cleanup report
        run: |
          cat > cleanup-report.md << EOF
          # ðŸ§¹ Cleanup Report
          
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Actions Taken
          - Removed log files older than 30 days
          - Compressed large log files (>10MB)
          - Cleaned up old test artifacts
          
          ## Current Status
          \`\`\`
          $(du -sh logs 2>/dev/null || echo "logs directory not found")
          $(du -sh tests/history 2>/dev/null || echo "tests/history directory not found")
          \`\`\`
          EOF
      
      - name: Upload cleanup report
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report
          path: cleanup-report.md

  update-dependencies:
    runs-on: ubuntu-latest
    if: github.event.inputs.update_deps != 'false'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Update Node dependencies
        id: update-node
        run: |
          if [ -f package.json ]; then
            echo "ðŸ“¦ Node.jsä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
            
            # package-lock.jsonã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            cp package-lock.json package-lock.json.bak 2>/dev/null || true
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ã¿
            npm audit fix || true
            
            # æ›´æ–°ãŒã‚ã£ãŸã‹ç¢ºèª
            if ! diff -q package-lock.json package-lock.json.bak >/dev/null 2>&1; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "âœ… Node.jsä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Node.jsä¾å­˜é–¢ä¿‚ã®æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“"
            fi
            
            rm -f package-lock.json.bak
          fi
      
      - name: Update Python dependencies
        id: update-python
        run: |
          if [ -f requirements.txt ]; then
            echo "ðŸ Pythonä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
            
            # requirements.txtã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            cp requirements.txt requirements.txt.bak
            
            # pip-toolsã‚’ä½¿ç”¨ã—ã¦æ›´æ–°ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            pip install pip-tools || true
            
            # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²
            pip freeze > current-versions.txt
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ç¢ºèª
            pip list --outdated --format=json > outdated.json || echo "[]" > outdated.json
            
            # æ›´æ–°ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ç¢ºèª
            if [ -s outdated.json ] && [ "$(jq length outdated.json)" -gt 0 ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "âœ… Pythonä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãŒå¿…è¦ã§ã™"
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Pythonä¾å­˜é–¢ä¿‚ã®æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“"
            fi
            
            rm -f requirements.txt.bak current-versions.txt outdated.json
          fi
      
      - name: Create update report
        run: |
          cat > dependency-report.md << EOF
          # ðŸ“¦ Dependency Update Report
          
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Node.js Dependencies
          EOF
          
          if [ -f package.json ]; then
            echo "### Security Vulnerabilities" >> dependency-report.md
            npm audit --json | jq -r '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity)"' >> dependency-report.md 2>/dev/null || echo "No vulnerabilities found" >> dependency-report.md
          else
            echo "No package.json found" >> dependency-report.md
          fi
          
          echo "" >> dependency-report.md
          echo "## Python Dependencies" >> dependency-report.md
          
          if [ -f requirements.txt ]; then
            echo "### Outdated Packages" >> dependency-report.md
            pip list --outdated 2>/dev/null | tail -n +3 >> dependency-report.md || echo "All packages are up to date" >> dependency-report.md
          else
            echo "No requirements.txt found" >> dependency-report.md
          fi
      
      - name: Create PR if updates needed
        if: steps.update-node.outputs.has_updates == 'true' || steps.update-python.outputs.has_updates == 'true'
        run: |
          git config user.name "CCTeam Bot"
          git config user.email "ccteam@bot.local"
          
          BRANCH="maintenance/deps-$(date +%Y%m%d)"
          git checkout -b $BRANCH
          
          git add -A
          git commit -m "chore: Update dependencies - $(date +%Y/%m/%d)

          - Security updates for npm packages
          - Dependency maintenance
          
          [skip ci]"
          
          git push origin $BRANCH
          
          gh pr create \
            --title "ðŸ”§ å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹: ä¾å­˜é–¢ä¿‚ã®æ›´æ–° - $(date +%Y/%m/%d)" \
            --body-file dependency-report.md \
            --base main \
            --label "dependencies,maintenance"

  generate-report:
    runs-on: ubuntu-latest
    needs: [cleanup, update-dependencies]
    if: always() && github.event.inputs.generate_report != 'false'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Generate comprehensive report
        run: |
          cat > maintenance-report.md << EOF
          # ðŸ”§ CCTeam Maintenance Report
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Triggered by**: ${{ github.event_name }}
          
          ## Summary
          
          | Task | Status |
          |------|--------|
          | Cleanup | ${{ needs.cleanup.result }} |
          | Dependency Update | ${{ needs.update-dependencies.result }} |
          
          ## Details
          
          EOF
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
          if [ -f artifacts/cleanup-report/cleanup-report.md ]; then
            echo "### Cleanup Details" >> maintenance-report.md
            cat artifacts/cleanup-report/cleanup-report.md >> maintenance-report.md
            echo "" >> maintenance-report.md
          fi
          
          # ãã®ä»–ã®æƒ…å ±
          echo "### Repository Statistics" >> maintenance-report.md
          echo "\`\`\`" >> maintenance-report.md
          echo "Total size: $(du -sh . | cut -f1)" >> maintenance-report.md
          echo "File count: $(find . -type f | wc -l)" >> maintenance-report.md
          echo "Directory count: $(find . -type d | wc -l)" >> maintenance-report.md
          echo "\`\`\`" >> maintenance-report.md
          
          echo "" >> maintenance-report.md
          echo "---" >> maintenance-report.md
          echo "*Generated by CCTeam Maintenance Workflow*" >> maintenance-report.md
      
      - name: Upload final report
        uses: actions/upload-artifact@v3
        with:
          name: maintenance-report
          path: maintenance-report.md
          retention-days: 90
      
      - name: Create issue if problems found
        if: needs.cleanup.result == 'failure' || needs.update-dependencies.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Maintenance Issues - ${date}`,
              body: `The following maintenance tasks failed:
              
              - Cleanup: ${{ needs.cleanup.result }}
              - Dependency Update: ${{ needs.update-dependencies.result }}
              
              Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['maintenance', 'automated']
            });