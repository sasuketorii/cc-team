# CCTeam初期化問題調査と解決策

作成日時: 2025年07月09日 22時30分00秒

## 確認された問題

### 1. Worker初期メッセージがBashコマンドを要求 ❌
- **症状**: WorkerがBashコマンド入力を求める
- **原因**: Claudeが完全に起動する前にメッセージが送信されている
- **影響**: 初期指示が正しく認識されない

### 2. Geminiプロンプト送信失敗 ❌
- **症状**: Geminiが初期メッセージに反応しない
- **原因**: 
  1. GeminiのCLI起動が遅い（Node.jsベース）
  2. プロンプト形式がClaude CLIと異なる
  3. Enterキーが効いていない

### 3. 不適切な起動タイミング ❌
- **現状**: 各エージェント起動後2秒で次の処理
- **問題**: 起動完了前にメッセージ送信

## 根本原因分析

### Claude CLIとGemini CLIの違い

| 項目 | Claude CLI | Gemini CLI |
|------|-----------|------------|
| 基盤 | ネイティブ | Node.js |
| 起動時間 | 比較的速い | 比較的遅い |
| プロンプト | 即座に表示 | 初期化後に表示 |
| 入力受付 | 起動後すぐ | 初期化完了後 |

## 解決策

### Phase 1: 即時修正（暫定対応）

1. **起動待機時間の延長**
```bash
# launch-ccteam.sh
# Claude起動後
sleep 5  # 2秒→5秒

# Gemini起動後  
sleep 7  # 2秒→7秒（Node.js起動のため長め）
```

2. **メッセージ送信前の待機延長**
```bash
# agent-send.sh
# Ctrl+C後の待機
sleep 1.5  # 0.5秒→1.5秒
```

### Phase 2: 起動確認メカニズム（推奨）

1. **起動完了確認関数**
```bash
wait_for_claude_ready() {
    local pane=$1
    local max_wait=30
    local count=0
    
    while [ $count -lt $max_wait ]; do
        # ペインの内容を確認
        if tmux capture-pane -t "$pane" -p | grep -q "claude>"; then
            return 0
        fi
        sleep 1
        ((count++))
    done
    return 1
}

wait_for_gemini_ready() {
    local pane=$1
    local max_wait=30
    local count=0
    
    while [ $count -lt $max_wait ]; do
        # Geminiのプロンプトパターンを確認
        if tmux capture-pane -t "$pane" -p | grep -q "gemini>"; then
            return 0
        fi
        sleep 1
        ((count++))
    done
    return 1
}
```

### Phase 3: Gemini専用送信メカニズム

1. **Gemini用カスタム送信**
```bash
send_to_gemini() {
    local message=$1
    
    # Geminiの特殊な起動シーケンス
    tmux send-keys -t ccteam-boss:main.1 C-c
    sleep 2
    tmux send-keys -t ccteam-boss:main.1 "$message"
    sleep 0.5
    tmux send-keys -t ccteam-boss:main.1 Enter
}
```

## 実装優先順位

### 最優先（即時対応）
1. launch-ccteam.shのsleep時間延長
2. agent-send.shの待機時間調整

### 次優先（根本対応）
3. 起動確認メカニズムの実装
4. Gemini専用送信方法の実装

### 将来対応
5. Claude/Gemini CLIの統合インターフェース検討
6. Web検索によるGemini CLI仕様調査

## テスト手順

1. **修正適用後のテスト**
```bash
# セッションクリーンアップ
tmux kill-server

# 再セットアップ
./scripts/setup.sh

# 起動テスト
./scripts/launch-ccteam.sh

# 各Workerの初期メッセージ確認
tmux attach -t ccteam-workers

# Geminiの応答確認
./scripts/agent-send.sh gemini "テストメッセージ"
```

2. **確認ポイント**
- [ ] WorkerがBashコマンドを要求しない
- [ ] 各Workerが正しい役割メッセージを表示
- [ ] Geminiが初期メッセージに応答
- [ ] Bossからの指示が正しく受信される

## まとめ

現在の問題は、CLIツールの起動タイミングと、Claude/Geminiの異なる実装に起因しています。短期的にはタイミング調整で対応し、長期的には起動確認メカニズムの実装が必要です。