# Claude Code 複数インスタンス認証問題調査報告書

作成日時: 2025年01月09日 20時55分46秒 (JST)
作成者: CCTeam
バージョン: 0.0.7

---

## 📋 概要

CCTeamプロジェクトにおいて、Claude Code CLIを複数インスタンス（Boss×1 + Worker×3）で起動する際に発生する認証ポート競合問題（Port 54545）の調査と、tmuxセッション構成およびGit worktree並列開発に関する技術的な分析を行いました。

## 🔍 調査結果

### 1. Port 54545認証エラーの根本原因

#### エラーメッセージ
```
Auth error: Port 54545 is already in use. Please ensure no other applications are using this port.
```

#### 技術的分析
1. **OAuth 2.0認証フローの制約**
   - Claude Code CLIはOAuth 2.0のAuthorization Code Flowを使用
   - 認証時にローカルホスト（localhost）のポート54545で一時的なWebサーバーを起動
   - このポート番号はアプリケーション内にハードコードされており、変更不可

2. **ポート競合の発生メカニズム**
   ```
   Boss起動 → Port 54545を占有 → 認証開始
   Worker1起動 → Port 54545にアクセス試行 → エラー（既に使用中）
   Worker2, Worker3も同様に失敗
   ```

3. **既知の問題**
   - GitHub Issue #2586: "OAuth port 54545 conflicts with macOS mobileactivationd"
   - Anthropicによってバグとして認識されているが、現時点で修正なし

### 2. 解決策：Dockerによる順次認証・並列運用戦略

#### 推奨アプローチ
**フェーズ1: 順次認証（State Generation）**
```bash
# 1. Dockerイメージ作成
docker build -t claude-agent:latest .

# 2. 各エージェントの順次認証
./authenticate_agent.sh boss
./authenticate_agent.sh worker1
./authenticate_agent.sh worker2
./authenticate_agent.sh worker3
```

**フェーズ2: 並列運用（Operation）**
```yaml
# docker-compose.yml
version: '3.8'
services:
  boss:
    image: claude-agent:latest
    volumes:
      - ./claude_config/boss:/root/.claude
    networks:
      - claude-net
  worker1:
    image: claude-agent:latest
    volumes:
      - ./claude_config/worker1:/root/.claude
    networks:
      - claude-net
  # worker2, worker3も同様
```

#### 実装手順
1. 各エージェントを独立したDockerコンテナで順番に認証
2. 認証トークンをホストマシンに保存
3. docker-composeで全エージェントを認証済み状態で並列起動

### 3. tmuxセッション構成に関する回答

#### 質問1への回答：tmuxセッションの独立性

**回答：いいえ、同一人物ではありません。**

現在のCCTeamの実装では：
- `ccteam-boss`セッション（2画面：Boss | Gemini）
- `ccteam`セッション（4画面：Boss | Worker1 | Worker2 | Worker3）

これらは**完全に独立したtmuxセッション**です。

```bash
# 確認方法
tmux ls
# 出力例：
# ccteam: 4 windows (created Thu Jan 9 15:00:00 2025) [160x50]
# ccteam-boss: 2 windows (created Thu Jan 9 15:01:00 2025) [160x50]
```

**技術的詳細：**
- 各セッションは独立したプロセス空間を持つ
- 一方のBossへの指示は、他方のBossには反映されない
- 同じClaude認証情報を使用していても、別々のインスタンス

### 4. Git worktreeに関する回答

#### 質問2への回答：worktreeの構成単位

**回答：1並列 = 1組織（Boss×1 + Worker×3 + Gemini×1）です。**

```
main/              # メインブランチ
├── Boss
├── Worker1
├── Worker2
├── Worker3
└── Gemini

worktree/feature-a/  # 並列開発ブランチ
├── Boss（別インスタンス）
├── Worker1（別インスタンス）
├── Worker2（別インスタンス）
├── Worker3（別インスタンス）
└── Gemini（別インスタンス）
```

**2並列の場合：**
- 合計：5名 × 2 = **10名のエージェント**が稼働
- 各worktreeで独立した組織が動作
- ブランチ間の干渉なし

#### 質問3への回答：worktreeの自動並列判断

**回答：いいえ、自動では判断しません。手動での設定が必要です。**

現在のCCTeamでは：
1. **手動でworktreeを作成**
   ```bash
   git worktree add ../worktrees/feature-x feature-x
   ```

2. **手動で各worktreeでCCTeamを起動**
   ```bash
   cd ../worktrees/feature-x
   ./scripts/launch-ccteam.sh
   ```

3. **将来的な自動化の可能性**
   - タスクの複雑度を分析して自動分岐
   - 競合検出による自動worktree作成
   - しかし現時点では未実装

## 💡 提案・改善策

### 短期的対策

1. **認証スクリプトの実装**
   ```bash
   #!/bin/bash
   # scripts/docker_auth_setup.sh
   
   # Dockerfileの作成
   cat > Dockerfile << 'EOF'
   FROM node:18-slim
   WORKDIR /app
   RUN npm install -g @anthropic-ai/claude-code --unsafe-perm
   CMD ["bash"]
   EOF
   
   # イメージビルド
   docker build -t claude-agent:latest .
   
   # 順次認証
   for agent in boss worker1 worker2 worker3; do
     echo "Authenticating $agent..."
     ./authenticate_agent.sh $agent
   done
   ```

2. **tmuxセッション管理の改善**
   - セッション名の明確化
   - 統一管理スクリプトの作成

### 長期的対策

1. **Anthropicへの働きかけ**
   - Issue #2586のフォローアップ
   - ポート設定可能性の要望

2. **並列開発の自動化**
   - worktree自動作成システム
   - タスク分析による並列判断AI

## 📈 実装計画

| フェーズ | 内容 | 期間 | 優先度 |
|---------|------|------|--------|
| Phase 1 | Docker認証システム構築 | 3日 | 高 |
| Phase 2 | tmuxセッション統合管理 | 1週間 | 中 |
| Phase 3 | worktree自動化システム | 2週間 | 低 |

## 🚀 次のアクション

1. Docker認証スクリプトの作成と実装
2. tmuxセッション管理ドキュメントの作成
3. worktree並列開発のベストプラクティス策定

## 📎 参考資料

- [Claude Code GitHub Issues](https://github.com/anthropics/claude-code/issues)
- [Docker Network Documentation](https://docs.docker.com/network/)
- [Git Worktree Documentation](https://git-scm.com/docs/git-worktree)
- 提供資料: CluadeCode認証エラー解消.txt

---

## 更新履歴

- 2025年01月09日 20時55分46秒 (JST): 初版作成