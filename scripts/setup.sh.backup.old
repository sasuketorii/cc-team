#!/bin/bash

# CCTeam çµ±åˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ v0.0.8
# Bossä¸€å…ƒåŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®Ÿè£…
# å‚è€ƒ: Claude-Code-Communication (https://github.com/Akira-Papa/Claude-Code-Communication)

set -euo pipefail

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸš€ CCTeam çµ±åˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹ (v0.0.8)${NC}"
echo ""

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
echo "ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆä¸­..."
mkdir -p logs memory reports tmp

# æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "æ—¢å­˜ã®tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
tmux kill-session -t ccteam 2>/dev/null || true
tmux kill-session -t ccteam-boss 2>/dev/null || true
tmux kill-session -t ccteam-support 2>/dev/null || true

# ãƒ¡ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆçµ±åˆBoss + Workersï¼‰
echo -e "${GREEN}çµ±åˆãƒ¡ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ 'ccteam' ã‚’ä½œæˆä¸­...${NC}"
tmux new-session -d -s ccteam -n main

# 2x2ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆ
echo "2x2ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ§‹æˆä¸­..."
# å³ã«åˆ†å‰²
tmux split-window -h -t ccteam:main
# å·¦ãƒšã‚¤ãƒ³ã‚’ä¸Šä¸‹ã«åˆ†å‰²
tmux split-window -v -t ccteam:main.0
# å³ãƒšã‚¤ãƒ³ã‚’ä¸Šä¸‹ã«åˆ†å‰²ï¼ˆæ­£ã—ã„ãƒšã‚¤ãƒ³ç•ªå·ã‚’ä½¿ç”¨ï¼‰
tmux split-window -v -t ccteam:main.2

# ãƒšã‚¤ãƒ³ã«åå‰ã‚’è¨­å®šï¼ˆtmux 3.0ä»¥é™ã®æ©Ÿèƒ½ï¼‰
if tmux -V | grep -qE "(^tmux 3\.|^tmux [4-9]\.)"; then
    echo "ãƒšã‚¤ãƒ³ã«åå‰ã‚’è¨­å®šä¸­..."
    tmux select-pane -t ccteam:main.0 -T "Boss (Unified)"
    tmux select-pane -t ccteam:main.1 -T "Worker1"
    tmux select-pane -t ccteam:main.2 -T "Worker2"
    tmux select-pane -t ccteam:main.3 -T "Worker3"
fi

# ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‡ç­‰ã«èª¿æ•´
tmux select-layout -t ccteam:main tiled

# Boss+Geminiã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆ2åˆ†å‰²ï¼‰
echo -e "${GREEN}Boss+Geminiã‚»ãƒƒã‚·ãƒ§ãƒ³ 'ccteam-boss' ã‚’ä½œæˆä¸­...${NC}"
tmux new-session -d -s ccteam-boss -n main
# å·¦å³ã«åˆ†å‰²ï¼ˆBoss | Geminiï¼‰
tmux split-window -h -t ccteam-boss:main

# ãƒšã‚¤ãƒ³ã«åå‰ã‚’è¨­å®š
if tmux -V | grep -qE "(^tmux 3\.|^tmux [4-9]\.)"; then
    tmux select-pane -t ccteam-boss:main.0 -T "Boss (Command)"
    tmux select-pane -t ccteam-boss:main.1 -T "Gemini (Advisor)"
fi

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–ä¸­..."
touch logs/boss.log
touch logs/worker1.log
touch logs/worker2.log
touch logs/worker3.log
touch logs/gemini.log
touch logs/system.log
touch logs/communication.log

# ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¨˜éŒ²
cat > logs/session_info.txt << EOF
CCTeam Session Information (v0.0.8)
Created: $(date)
Architecture: Unified Boss with Advisor

Sessions:
- ccteam: Main session (Boss + 3 Workers)
  - Pane 0: Boss (Unified)
  - Pane 1: Worker1
  - Pane 2: Worker2
  - Pane 3: Worker3
- ccteam-boss: Boss command session (Boss + Gemini)
  - Pane 0: Boss (Command Center)
  - Pane 1: Gemini (Strategic Advisor)

Note: Boss in both sessions are synchronized. Gemini acts as strategic advisor to Boss.
EOF

# AIãƒ¢ãƒ‡ãƒ«è¨­å®šã®å®Ÿè¡Œ
if [[ -f "scripts/setup-models-simple.sh" ]]; then
    echo ""
    echo -e "${YELLOW}AIãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’é–‹å§‹ã—ã¾ã™...${NC}"
    ./scripts/setup-models-simple.sh
fi

echo ""
echo -e "${GREEN}âœ… çµ±åˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼${NC}"
echo ""
echo "ðŸ“‹ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ§‹æˆ:"
echo "  - ccteam (ãƒ¡ã‚¤ãƒ³): Boss + Worker1-3"
echo "  - ccteam-boss: Boss + Geminiï¼ˆç›¸è«‡å½¹ï¼‰"
echo ""
echo "ðŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "  1. tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æŽ¥ç¶š: tmux attach -t ccteam"
echo "  2. CCTeamã‚’èµ·å‹•: ./scripts/launch-ccteam.sh"
echo ""
echo -e "${BLUE}ðŸ’¡ ãƒ’ãƒ³ãƒˆ: Bossã¯ä¸¡æ–¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§åŒæœŸã—ã¦ã„ã¾ã™ã€‚Geminiã¯ç›¸è«‡å½¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™${NC}"