# CCTeam メモリ・ログシステムアーキテクチャ

## 現在の実装状況

### メモリシステム（memory_manager.py）
- **データベース**: SQLite（`memory/ccteam_memory.db`）
- **スコープ**: プロジェクト全体で単一のデータベース
- **特徴**: 全エージェントが同じメモリを共有

### ログシステム（structured_logger.py）
- **ログファイル**: 各エージェント個別（`logs/{agent_name}.log`）
- **構造化ログ**: JSON形式（`logs/{agent_name}_structured.jsonl`）
- **エラーログ**: 統合（`logs/errors_all.jsonl`）

## v4構造での推奨アーキテクチャ

### 1. メモリシステム - 統合アプローチ（推奨）
```
memory/
├── ccteam_memory.db  # 全体共有メモリ（現状維持）
└── session_cache/    # セッション別キャッシュ
```

**理由**:
- tmuxセッション間でのメモリ共有が容易
- Bossが全体の情報を把握可能
- チーム間の知識共有が自然に実現
- データベースの管理が簡潔

### 2. ログシステム - ハイブリッドアプローチ
```
logs/
├── system.log              # システム全体
├── boss.log                # Boss専用
├── team1/                  # Team1ログ
│   ├── pm1.log
│   ├── worker1-1.log
│   ├── worker1-2.log
│   └── worker1-3.log
├── team2/                  # Team2ログ
│   └── ...
├── team3/                  # Team3ログ
│   └── ...
└── errors_all.jsonl        # 統合エラーログ
```

**利点**:
- チーム単位でのログ管理
- エラーは統合して監視
- ディレクトリ構造で整理

## 実装の整合性

### 現在の整合性評価
- ✅ **メモリシステム**: 単一DB、全エージェント共有
- ✅ **構造化ログ**: 各エージェント個別ファイル
- ✅ **エラーループ検出**: 全チーム監視可能
- ⚠️ **ログファイル**: チーム構造に未対応（フラット構成）

### コンフリクト回避策
1. **メモリ書き込み**: エージェント名をキーに含める
2. **ログローテーション**: 日次でアーカイブ
3. **同時アクセス**: SQLiteのWALモード使用
4. **エラー検出**: チーム別フィルタリング機能

## 結論

現在の実装は基本的に適切であり、v4構造でも機能します：
- **メモリ**: 単一共有DBが最適（チーム別分離は不要）
- **ログ**: 将来的にチーム別ディレクトリ化を検討
- **整合性**: 大きな問題なし、マイナーな改善余地あり